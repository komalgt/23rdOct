name: Notify Deployment Status

on:
  workflow_call:
    inputs:
      deployment_status:
        required: true
        type: string
      repo:
        required: true
        type: string
      sha:
        required: true
        type: string
      recipient_email:
        required: true
        type: string

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Email Deploy Status
  env:
    SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
    SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
    RECIPIENT_EMAIL: ${{ inputs.recipient_email }}
    COMMIT_SHA: ${{ inputs.sha }}
    DEPLOYMENT_STATUS: ${{ inputs.deployment_status }}
    REPO: ${{ inputs.repo }}
  run: |
    python - <<EOF
    # Code Generated by Sidekick is for learning and experimentation purposes only.
    import smtplib
    from email.mime.text import MIMEText

    sender = '${{ env.SMTP_USERNAME }}'
    password = '${{ env.SMTP_PASSWORD }}'
    recipient = '${{ env.RECIPIENT_EMAIL }}'
    subject = f"[${{ env.REPO }}] Deployment Status: ${{ env.DEPLOYMENT_STATUS }}"
    body = f"Repository: ${{ env.REPO }}\nCommit: ${{ env.COMMIT_SHA }}\nDeployment Status: ${{ env.DEPLOYMENT_STATUS }}"

    msg = MIMEText(body)
    msg['Subject'] = subject
    msg['From'] = sender
    msg['To'] = recipient

    with smtplib.SMTP('smtp.gmail.com', 587) as server:
        server.ehlo()
        server.starttls()
        server.login(sender, password)
        server.sendmail(sender, recipient, msg.as_string())
    EOF
